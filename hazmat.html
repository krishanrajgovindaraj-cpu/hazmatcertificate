<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OZELLAR MARINE Certificate Generator</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    body {
      font-family: Calibri, sans-serif;
      margin: 30px;
      background-color: #ffffff;
    }

    .form-container {
      border: 2px solid #aa2f2f;
      padding: 20px;
      width: 320px;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-top: 12px;
      font-weight: bold;
    }

    input {
      width: 100%;
      padding: 6px;
      margin-top: 5px;
      box-sizing: border-box;
    }

    button {
      margin-top: 12px;
      padding: 6px 12px;
      background-color: #347c05;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
@page {
  size: A4;
  margin: 0;
}

body {
  margin: 0;
  padding: 0;
}

.certificate {
  width: 200mm;          /* A4 width */
  min-height: 260mm;     /* A4 height */
  margin: 0 auto;
  padding: 20mm;
  border: 2px solid #000;
  box-sizing: border-box;
  background: #fff;
  position: relative;
  display: block;        /* IMPORTANT: must be visible */
}


    #companyLogo {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 120px;
      display: none;
    }

    #signatureImage {
      position: absolute;
      bottom: 185px;
      right: 75px;
      width: 150px;
      display: none;
    }

    #candidatePhoto {
      position: absolute;
      top: 210mm;
      left: 15mm;
      width: 30mm;
      height: 30mm;
      object-fit: cover;
      border: 1px solid #000;
      display: none;
    }

    .underline {
      border-bottom: 1px solid #000;
      padding: 0 10px;
      min-width: 120px;
      display: inline-block;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
    }

    table, th, td {
      border: 1px solid #000;
    }

    th, td {
      padding: 5px;
      text-align: center;
      font-size: 14px;
    }
  </style>
</head>

<body>

<h3>Total Certificates Generated: <span id="certCount">0</span></h3>

<button onclick="toggleList()">Show / Hide Generated List</button>

<div id="listSection" style="display:none; margin-top:20px;">
  <h3>Generated Certificate List</h3>

  <button onclick="deleteSelected()" style="background:orange;color:white;">
    Delete Selected
  </button>

  <button onclick="exportToCSV()" style="background:green;color:white;">
    Export to Excel
  </button>

  <table>
    <thead>
      <tr>
        <th>Select</th>
        <th>#</th>
        <th>Certificate No</th>
        <th>Candidate Name</th>
        <th>PP No</th>
        <th>Conducted Date</th>
        <th>Location</th>
        <th>Issue Date</th>
        <th>Delete</th>
      </tr>
    </thead>
    <tbody id="certListBody"></tbody>
  </table>
</div>

<h1 style="color:#ED7C31;">HAZMAT TRAINING</h1>

<div class="form-container" id="entryForm">

   <label>Certificate No</label>
  <input type="text" id="certNo" required>

  <label>Candidate Name</label>
  <input type="text" id="candidateName" required>

  <label>PP No</label>
  <input type="text" id="ppNo"required>

  <label>Conducted Date</label>
  <input type="date" id="conductedDate">

  <label>Conducted At</label>
  <input type="text" id="conductedAt">

  <label>Issue Date</label>
  <input type="date" id="issueDate">

  <label>Upload Company Logo</label>
  <input type="file" id="logoUpload" accept="image/*">

  <label>Upload Signature</label>
  <input type="file" id="signatureUpload" accept="image/*">

  <label>Upload Candidate Photo</label>
  <input type="file" id="photoUpload" accept="image/*">

  <button onclick="generateCertificate()">Generate Certificate</button>
  <button id="downloadBtn" style="display:none;" onclick="downloadPDF()">Download PDF</button>
</div>

<div id="certificate" class="certificate">

  <img id="companyLogo">
  <img id="candidatePhoto">

  <div style="text-align:center; margin-top:20px;">
    <h2 style="color:#ED7C31;">OZELLAR MARINE PRIVATE LIMITED</h2>
    <p><strong>Aneja Towers, B Block 4th Floor,<br>Perungudi, Chennai â€“ 600096</strong></p>
  </div>
<br>
  <p style="text-align:right;">
    Certificate No: <span class="underline" id="outCertNo"></span>
  </p>
  <p>This is to certify that <strong><span class="underline" id="outCandidateName"></span></strong></p>

  <p>PP No <span class="underline" id="outPPNo"></span> has successfully completed</p>
<br>
  <h2 style="text-align:center;">HAZMAT Certificates </h2>

  <p style="text-align:center;">
    Conducted on <span class="underline" id="outConductedDate"></span>
    at <span class="underline" id="outConductedAt"></span>
  </p>
  <p style="margin:0; font-size:15px; display:flex; justify-content:space-between;">
    <span>Mode: Classroom</span>
    <span>Duration: 2 hours</span>
</p> <br>
  <h2 style="font-size:19px;">This course covered the following topics:</h2> 
  <ul style="font-size:14px; line-height:2.1;">
    <li>International Rules & Regulations in carriage of Cargo in</li>
    <li>Bulk Classification of Dangerous Goods as per IMSBC</li>
    <li>Code Hazards related to Carriage of cargo in Bulk</li>
    <li>Documentation requirement with regard to Bulk cargo</li>
    <li>Emergency Procedures</li>
    <li>Medical First Aid Guide</li>
  </ul>

 <div style="position:absolute; bottom:150px; right:80px; text-align:right;">
  _______________________<br>
  Course In-Charge Signature
</div>
<br>
<br>
  <p style="position:absolute; bottom:20px; left:40px;">
    Date of Issue: <span class="underline" id="outIssueDate"></span>
  </p>

  <img id="signatureImage">

</div>

<script>

const SHEET_URL = "https://script.google.com/macros/s/AKfycbyqtiCjRuS7Xu0VtMUK2o6Q2PE0I1w9h1JXs0Ex3txl9gSmb2Dr4ocwTjORqbW15-ThQA/exec";

const STORAGE_KEY_COUNT = "certCount_HAZMAT";
const STORAGE_KEY_LIST = "certificateList_HAZMAT";

let certCount = Number(localStorage.getItem(STORAGE_KEY_COUNT)) || 0;
let certificateList = JSON.parse(localStorage.getItem(STORAGE_KEY_LIST)) || [];

// Show saved count on page load
document.getElementById("certCount").innerText = certCount;
renderList();


/* ============================= */
/* IMAGE UPLOAD SECTION */
/* ============================= */

logoUpload.onchange = e => {
  const r = new FileReader();
  r.onload = () => { 
    companyLogo.src = r.result; 
    companyLogo.style.display="block"; 
  };
  r.readAsDataURL(e.target.files[0]);
};

signatureUpload.onchange = e => {
  const r = new FileReader();
  r.onload = () => { 
    signatureImage.src = r.result; 
    signatureImage.style.display="block"; 
  };
  r.readAsDataURL(e.target.files[0]);
};

photoUpload.onchange = e => {
  const r = new FileReader();
  r.onload = () => { 
    candidatePhoto.src = r.result; 
    candidatePhoto.style.display="block"; 
  };
  r.readAsDataURL(e.target.files[0]);
};


/* ============================= */
/* GENERATE CERTIFICATE */
/* ============================= */

function generateCertificate() {

  outCertNo.innerText = certNo.value;
  outCandidateName.innerText = candidateName.value;
  outPPNo.innerText = ppNo.value;
  outConductedDate.innerText = conductedDate.value;
  outConductedAt.innerText = conductedAt.value;
  outIssueDate.innerText = issueDate.value || new Date().toLocaleDateString("en-GB");

  certificate.style.display = "block";
  downloadBtn.style.display = "inline-block";

  // Increase counter
  certCount++;

  // Create data object
  const newData = {
    sheetName: "HAZMAT",  // Change per page if needed
    certNo: certNo.value,
    name: candidateName.value,
    ppNo: ppNo.value,
    conductedDate: conductedDate.value,
    conductedAt: conductedAt.value,
    issueDate: outIssueDate.innerText
  };

  // Add to list
  certificateList.push(newData);

  // Save to localStorage
  localStorage.setItem(STORAGE_KEY_COUNT, certCount);
  localStorage.setItem(STORAGE_KEY_LIST, JSON.stringify(certificateList));

  // Update UI
  document.getElementById("certCount").innerText = certCount;
  renderList();

  // Send to Google Sheet
  saveToGoogleSheet(newData);
}


/* ============================= */
/* SAVE TO GOOGLE SHEET */
/* ============================= */

function saveToGoogleSheet(data) {
  fetch(SHEET_URL, {
    method: "POST",
    mode: "no-cors",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify(data)
  })
  .then(() => console.log("Saved to Google Sheet"))
  .catch(error => console.error("Error:", error));
}


/* ============================= */
/* RENDER CERTIFICATE LIST */
/* ============================= */

function renderList() {
  certListBody.innerHTML = "";

  certificateList.forEach((c, i) => {
    certListBody.innerHTML += `
      <tr>
        <td><input type="checkbox" class="rowCheck"></td>
        <td>${i+1}</td>
        <td>${c.certNo}</td>
        <td>${c.name}</td>
        <td>${c.ppNo}</td>
        <td>${c.conductedDate}</td>
        <td>${c.conductedAt}</td>
        <td>${c.issueDate}</td>
        <td>
          <button onclick="deleteOne(${i})" 
          style="background:red;color:white;border:none;padding:5px 8px;">
          X
          </button>
        </td>
      </tr>`;
  });
}


/* ============================= */
/* DELETE FUNCTIONS */
/* ============================= */

function deleteOne(i){
  certificateList.splice(i,1);
  localStorage.setItem(STORAGE_KEY_LIST, JSON.stringify(certificateList));
  renderList();
}

function deleteSelected(){
  const checks = document.querySelectorAll(".rowCheck");

  certificateList = certificateList.filter((_,i)=>!checks[i].checked);

  localStorage.setItem(STORAGE_KEY_LIST, JSON.stringify(certificateList));
  renderList();
}


/* ============================= */
/* EXPORT TO CSV */
/* ============================= */

function exportToCSV(){
  let csv="Certificate No,Candidate Name,PP No,Conducted Date,Location,Issue Date\n";

  certificateList.forEach(c=>{
    csv+=`"${c.certNo}","${c.name}","${c.ppNo}","${c.conductedDate}","${c.conductedAt}","${c.issueDate}"\n`;
  });

  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="Generated_Certificates.csv";
  a.click();
}


/* ============================= */
/* TOGGLE LIST */
/* ============================= */

function toggleList(){
  listSection.style.display =
    listSection.style.display==="none"?"block":"none";
}


/* ============================= */
/* DOWNLOAD PDF */
/* ============================= */

function downloadPDF(){

  entryForm.style.display="none";

  setTimeout(()=>{
    html2pdf().from(certificate).set({
      filename: candidateName.value+"_Certificate.pdf",
      html2canvas:{scale:2},
      jsPDF:{format:"a4"}
    }).save().then(()=>{
      entryForm.style.display="block";
    });

  },800);
}


/* ============================= */
/* RESET COUNTER */
/* ============================= */

function resetCounter(){
  if(confirm("Are you sure you want to reset certificate count?")){
    certCount = 0;
    localStorage.setItem(STORAGE_KEY_COUNT, certCount);
    document.getElementById("certCount").innerText = certCount;
  }
}

</script>
</body>
</html> 