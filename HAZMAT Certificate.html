<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>OZELLAR MARINE Certificate Generator</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body{font-family:Calibri,sans-serif;margin:30px;background:#fff}
.form-container{border:2px solid #000;padding:20px;width:420px;border-radius:10px;margin-bottom:40px}
label{display:block;margin-top:12px;font-weight:bold}
input{width:100%;padding:6px;margin-top:5px;box-sizing:border-box}
button{margin-top:12px;padding:6px 12px;background:#347c05;color:#fff;border:none;border-radius:5px;cursor:pointer}
.certificate{width:744px;height:1073px;margin:auto;padding:20px;border:2px solid #000;box-sizing:border-box;display:none;position:relative}
#companyLogo{position:absolute;top:20px;right:20px;width:120px;display:none}
#signatureImage{position:absolute;bottom:185px;right:75px;width:150px;display:none}
.underline{border-bottom:1px solid #000;padding:0 10px;min-width:120px;display:inline-block}
table{border-collapse:collapse;width:100%;margin-top:10px}
table,th,td{border:1px solid #000}
th,td{padding:5px;text-align:center;font-size:14px}
</style>
</head>

<body>

<h3>Total Certificates Generated: <span id="certCount">0</span></h3>
<button onclick="toggleList()">Show / Hide Generated List</button>

<div id="listSection" style="display:none;margin-top:20px">
<h3>Generated Certificate List</h3>
<button onclick="deleteSelected()" style="background:orange;color:white">Delete Selected</button>
<button onclick="exportToCSV()" style="background:green;color:white">Export to Excel</button>

<table>
<thead>
<tr>
<th>Select</th><th>#</th><th>Certificate No</th><th>Name</th>
<th>PP No</th><th>Conducted Date</th><th>Location</th>
<th>Issue Date</th><th>Delete</th>
</tr>
</thead>
<tbody id="certListBody"></tbody>
</table>
</div>

<h1 style="color:#ED7C31;">HAZMAT Certificates</h1>

<!-- ================= FORM ================= -->
<div class="form-container" id="entryForm">

  <label>Certificate No</label>
  <input type="text" id="certNo">

  <label>Candidate Name</label>
  <input type="text" id="candidateName">

  <label>PP No</label>
  <input type="text" id="ppNo">

  <label>Conducted Date</label>
  <input type="text" id="conductedDate">

  <label>Conducted At</label>
  <input type="text" id="conductedAt">

  <label>Issue Date</label>
  <input type="text" id="issueDate">

  <label>Upload Company Logo</label>
  <input type="file" id="logoUpload" accept="image/*">

  <label>Upload Signature</label>
  <input type="file" id="signatureUpload" accept="image/*">

  <button onclick="generateCertificate()">Generate Certificate</button>
  <button id="downloadBtn" style="display:none;" onclick="downloadPDF()">Download PDF</button>
</div>

<!-- ================= CERTIFICATE ================= -->
<div id="certificate" class="certificate">

  <img id="companyLogo">

  <div style="text-align:center; margin-top:20px;">
    <h2 style="color:#ED7C31;">OZELLAR MARINE PRIVATE LIMITED</h2>
    <p><strong>Aneja Towers, B Block 4th Floor,<br>Perungudi, Chennai â€“ 600096</strong></p>
  </div>
</br>
  <p style="text-align:right;">
    Certificate No: <span class="underline" id="outCertNo"></span>
  </p>
</br>
  <p>This is to certify that <strong><span class="underline" id="outCandidateName"></span></strong></p>

  <p>PP No <span class="underline" id="outPPNo"></span> has successfully completed</p>
</br>
  <h2 style="text-align:center;">HAZMAT Training</h2>
</br>
  <p style="text-align:center;">
    Conducted on <span class="underline" id="outConductedDate"></span>
    at <span class="underline" id="outConductedAt"></span>
  </p>
</br>

<p style="margin:0; font-size:15px; display:flex; justify-content:space-between;">
    <span>Mode: Classroom</span>
    <span>Duration: 2 hours</span>
</p> </br>
  <h2 style="font-size:19px;">This course covered the following topics:</h2>
  <ul style="font-size:16px; line-height:2.1;">
    <li>International Rules & Regulations in carriage of Cargo in </li>
    <li>Bulk Classification of Dangerous Goods as per IMSBC </li>
    <li>Code Hazards related to Carriage of cargo in Bulk</li>
    <li>Documentation requirement with regard to Bulk cargo </li>
    <li>Emergency Procedures</li>
    <li>Medical First Aid Guide</li>
  </ul>

  <div style="position:absolute; bottom:150px; left:80px; width:620px; display:flex; justify-content:space-between;">
    <div>_______________________<br>Candidate Signature</div>
    <div>_______________________<br>Course In-Charge Signature</div>
  </div>

  <p style="position:absolute; bottom:50px; left:40px;">
    Date of Issue: <span class="underline" id="outIssueDate"></span>
  </p>

  <img id="signatureImage">

</div>
    <script>
/* ===== LOCAL STORAGE (PERSISTENT) ===== */
let certCount = Number(localStorage.getItem("hazmat_certCount")) || 0;
let certificateList = JSON.parse(localStorage.getItem("hazmat_certificateList")) || [];

const certCountSpan = document.getElementById("certCount");
certCountSpan.innerText = certCount;

renderList();

/* ===== LOGO UPLOAD ===== */
logoUpload.onchange = e => {
  const r = new FileReader();
  r.onload = () => {
    companyLogo.src = r.result;
    companyLogo.style.display = "block";
  };
  r.readAsDataURL(e.target.files[0]);
};

/* ===== SIGNATURE UPLOAD ===== */
signatureUpload.onchange = e => {
  const r = new FileReader();
  r.onload = () => {
    signatureImage.src = r.result;
    signatureImage.style.display = "block";
  };
  r.readAsDataURL(e.target.files[0]);
};

/* ===== GENERATE CERTIFICATE ===== */
function generateCertificate() {
  if (!certNo.value || !candidateName.value) {
    alert("Enter Certificate No & Candidate Name");
    return;
  }

  outCertNo.innerText = certNo.value;
  outCandidateName.innerText = candidateName.value;
  outPPNo.innerText = ppNo.value;
  outConductedDate.innerText = conductedDate.value;
  outConductedAt.innerText = conductedAt.value;
  outIssueDate.innerText =
    issueDate.value || new Date().toLocaleDateString("en-GB");

  certificate.style.display = "block";
  downloadBtn.style.display = "inline-block";

  certCount++;
  localStorage.setItem("hazmat_certCount", certCount);
  certCountSpan.innerText = certCount;

  certificateList.push({
    certNo: certNo.value,
    name: candidateName.value,
    ppNo: ppNo.value,
    conductedDate: conductedDate.value,
    conductedAt: conductedAt.value,
    issueDate: outIssueDate.innerText
  });

  localStorage.setItem(
    "hazmat_certificateList",
    JSON.stringify(certificateList)
  );

  renderList();
}

/* ===== RENDER LIST ===== */
function renderList() {
  certListBody.innerHTML = "";
  certificateList.forEach((c, i) => {
    certListBody.innerHTML += `
      <tr>
        <td><input type="checkbox" class="rowCheck"></td>
        <td>${i + 1}</td>
        <td>${c.certNo}</td>
        <td>${c.name}</td>
        <td>${c.ppNo}</td>
        <td>${c.conductedDate}</td>
        <td>${c.conductedAt}</td>
        <td>${c.issueDate}</td>
        <td>
          <button onclick="deleteOne(${i})" style="background:red;color:white">
            X
          </button>
        </td>
      </tr>`;
  });
}

/* ===== DELETE ONE ===== */
function deleteOne(i) {
  if (!confirm("Delete this certificate?")) return;
  certificateList.splice(i, 1);
  localStorage.setItem(
    "hazmat_certificateList",
    JSON.stringify(certificateList)
  );
  renderList();
}

/* ===== DELETE SELECTED ===== */
function deleteSelected() {
  const checks = document.querySelectorAll(".rowCheck");
  certificateList = certificateList.filter((_, i) => !checks[i].checked);
  localStorage.setItem(
    "hazmat_certificateList",
    JSON.stringify(certificateList)
  );
  renderList();
}

/* ===== EXPORT TO CSV ===== */
function exportToCSV() {
  let csv =
    "Certificate No,Name,PP No,Conducted Date,Location,Issue Date\n";
  certificateList.forEach(c => {
    csv += `"${c.certNo}","${c.name}","${c.ppNo}","${c.conductedDate}","${c.conductedAt}","${c.issueDate}"\n`;
  });

  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "Generated_Certificates.csv";
  a.click();
}

/* ===== TOGGLE LIST ===== */
function toggleList() {
  listSection.style.display =
    listSection.style.display === "none" ? "block" : "none";
}

/* ===== DOWNLOAD PDF ===== */
function downloadPDF() {
  entryForm.style.display = "none";

  setTimeout(() => {
    html2pdf()
      .from(certificate)
      .set({
        filename: candidateName.value + "_Certificate.pdf",
        margin: 0,
        html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
        jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
      })
      .save()
      .then(() => (entryForm.style.display = "block"));
  }, 500);
}

/* ===== OPTIONAL: CLEAR ALL DATA ===== */
function clearAllData() {
  if (confirm("Delete ALL stored certificates?")) {
    localStorage.clear();
    location.reload();
  }
}
</script>
</body>
</html>
