<!DOCTYPE html>
<html>
<head>
  <title>OZELLAR MARINE - ESE Certificate Generator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    body {
      font-family: Calibri, sans-serif;
      margin: 30px;
      background: #ffffff;
    }

    .form-container {
      border: 2px solid #000;
      padding: 20px;
      width: 420px;
      border-radius: 10px;
      background-color: white;
      margin-bottom: 40px;
    }

    label { display:block; margin-top:12px; }
    input { width:100%; padding:6px; margin-top:4px; }

    button {
      margin-top: 10px;
      padding: 6px 12px;
      background-color: #347c05;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .certificate {
      width: 744px;
      height: 1073px;
      padding: 15mm;
      border: 2px solid #000;
      background: white;
      margin: auto;
      display: none;
      position: relative;
      box-sizing: border-box;
      page-break-after: always;
    }

    #companyLogo {
      position: absolute;
      top: 15mm;
      right: 15mm;
      width: 35mm;
      display: none;
    }

    #candidatePhoto {
      position: absolute;
      top: 210mm;
      left: 15mm;
      width: 31mm;
      height: 40mm;
      object-fit: cover;
      border: 1px solid #000;
      display: none;
    }

    #signatureImage {
      position: absolute;
      bottom: 180px;
      right: 85px;
      width: 40mm;
      display: none;
    }

    .underline {
      border-bottom: 1px solid #000;
      padding: 0 5px;
      min-width: 120px;
      display: inline-block;
    }

    @page {
      size: A4 portrait;
      margin: 0;
    }
  </style>
</head>

<body>

<h1 style="color:#ED7C31;">ENCLOSED SPACE ENTRY TRAINING</h1>

<div class="form-container">
  <label>Certificate No</label><input id="certNo">
  <label>Candidate Name</label><input id="name">
  <label>PP No</label><input id="ppNo">
  <label>Conducted Date</label><input id="conductedDate">
  <label>Conducted At</label><input id="conductedAt">
  <label>Issue Date</label><input id="issueDate">

  <label>Upload Company Logo</label><input type="file" id="logoUpload">
  <label>Upload Course Incharge Signature</label><input type="file" id="signatureUpload">
  <label>Upload Passport Size Photo</label><input type="file" id="photoUpload" accept="image/*">

  <button type="button" onclick="generateCertificate()">Generate Certificate</button>
  <button type="button" id="downloadBtn" style="display:none;" onclick="downloadPDF()">Download PDF</button>
</div>

<div id="certificate" class="certificate">

  <img id="companyLogo">
  <img id="candidatePhoto">

  <div style="text-align:center;">
    <h2 style="color:#ED7C31;">OZELLAR MARINE PRIVATE LIMITED</h2>
    <p>
      Aneja Towers, B Block 4th Floor<br>
      Plot 4 & 5, Developed Plot Estate<br>
      Perungudi, Chennai â€“ 600096
    </p>
  </div>

  <h3 style="text-align:right;">
    Certificate No: <span class="underline" id="outCertNo"></span>
  </h3>

  <p>This is to certify that <span class="underline" id="outName"></span></p>
  <p>PP No <span class="underline" id="outPPNo"></span></p>

  <h2 style="text-align:center;">ENCLOSED SPACE ENTRY TRAINING</h2>
</br>
  <p style="text-align:center;">
    Conducted on <span class="underline" id="outConductedDate"></span>
    at <span class="underline" id="outConductedAt"></span>
  </p>
</br>
</br>
  <h3>This course covered the following topics:</h3>

  <ul style="font-size:16px; line-height:2;">
    <li>Regulatory Requirement IMO Resolution A.1050(27), COWSP Chapter 15</li>
    <li>Hazard related to enclosed spaces</li>
    <li>Enclosed space entry procedure</li>
    <li>Equipment and procedures required for enclosed space entry</li>
    <li>Enclosed space entry procedure as per Company Manuals</li>
    <li>Emergency response procedure</li>
  </ul>

  <div style="position:absolute; bottom:150px; right:80px;">
    _______________________<br>Course Incharge Signature
  </div>

  <p style="position:absolute; bottom:50px; left:40px;">
    Date of Issue: <span class="underline" id="outIssueDate"></span>
  </p>

  <img id="signatureImage">

</div>

<script>

const SHEET_URL = "https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec";

// -------------------- Generate Certificate --------------------
function generateCertificate() {

  const certNo = document.getElementById("certNo").value;
  const name = document.getElementById("name").value;
  const ppNo = document.getElementById("ppNo").value;
  const conductedDate = document.getElementById("conductedDate").value;
  const conductedAt = document.getElementById("conductedAt").value;
  const issueDateInput = document.getElementById("issueDate").value;

  if (!certNo || !name || !ppNo || !conductedDate || !conductedAt) {
    alert("Please fill all required fields.");
    return;
  }

  // Show data on certificate
  document.getElementById("outCertNo").textContent = certNo;
  document.getElementById("outName").textContent = name;
  document.getElementById("outPPNo").textContent = ppNo;
  document.getElementById("outConductedDate").textContent = conductedDate;
  document.getElementById("outConductedAt").textContent = conductedAt;
  document.getElementById("outIssueDate").textContent =
      issueDateInput || new Date().toLocaleDateString("en-GB");

  document.getElementById("certificate").style.display = "block";
  document.getElementById("downloadBtn").style.display = "inline-block";

  // Send data to Google Sheet
  fetch(SHEET_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      certNo: certNo,
      name: name,
      ppNo: ppNo,
      conductedDate: conductedDate,
      conductedAt: conductedAt,
      issueDate: document.getElementById("outIssueDate").textContent,
      // Add extra fields if needed
      additionalField1: "Extra data 1",
      additionalField2: "Extra data 2"
    })
  })
  .then(res => res.json())
  .then(() => {
    console.log("Data sent to Google Sheet");
    updateCertCount(); // refresh certificate count
  })
  .catch(err => console.error(err));
}

// -------------------- Download PDF --------------------
function downloadPDF() {
  const element = document.getElementById("certificate");
  const candidateName = document.getElementById("name").value || "Certificate";

  const opt = {
    margin: 0,
    filename: candidateName + "_Certificate.pdf",
    image: { type: "jpeg", quality: 1 },
    html2canvas: { scale: 3, useCORS: true, scrollY: 0 },
    jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
  };

  html2pdf().set(opt).from(element).save();
}

// -------------------- Image Upload Handlers --------------------
document.getElementById("logoUpload").onchange = function(e) {
  const reader = new FileReader();
  reader.onload = () => {
    const logo = document.getElementById("companyLogo");
    logo.src = reader.result;
    logo.style.display = "block";
  };
  reader.readAsDataURL(e.target.files[0]);
};

document.getElementById("signatureUpload").onchange = function(e) {
  const reader = new FileReader();
  reader.onload = () => {
    const sign = document.getElementById("signatureImage");
    sign.src = reader.result;
    sign.style.display = "block";
  };
  reader.readAsDataURL(e.target.files[0]);
};

document.getElementById("photoUpload").onchange = function(e) {
  const reader = new FileReader();
  reader.onload = () => {
    const photo = document.getElementById("candidatePhoto");
    photo.src = reader.result;
    photo.style.display = "block";
  };
  reader.readAsDataURL(e.target.files[0]);
};

// -------------------- Certificate Count --------------------
function updateCertCount() {
  fetch(SHEET_URL)
    .then(res => res.json())
    .then(data => {
      let counterEl = document.getElementById("certCount");
      if (!counterEl) {
        // Create element if not exists
        const p = document.createElement("p");
        p.innerHTML = `Certificates Issued: <span id="certCount">${data.count || 0}</span>`;
        document.querySelector(".form-container").prepend(p);
      } else {
        counterEl.textContent = data.count || 0;
      }
    })
    .catch(err => console.error("Error fetching certificate count:", err));
}

// Call once on page load
updateCertCount();

</script>


</body>
</html>